import streamlit as st
import yfinance as yf
import plotly.graph_objects as go
import matplotlib.pyplot as plt
from statsmodels.graphics.tsaplots import plot_acf, plot_pacf

# –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
@st.cache_data
def get_data():
    try:
        # –¢–∏–∫–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏
        tick = yf.Ticker("AMD")
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Yahoo Finance
        data_1 = tick.history(start="2020-01-01")
        # –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –¥–∞—Ç
        df_1 = data_1["Close"].resample("1D").mean().ffill()
        return data_1, df_1
    except Exception as e:
        st.error(f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}', icon="üö®")

st.markdown('#### üèÇ –ú–æ–¥–µ–ª—å —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ (MA) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤...')
st.markdown('##### üíπ –î–∞–Ω–Ω—ã–µ Yahoo Finance –æ –∫–æ—Ç–∏—Ä–æ–≤–∫–∞—Ö –∞–∫—Ü–∏–π')

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä—É–≥–æ–≤–æ–π —Å–ø–∏–Ω–Ω–µ—Ä
with st.spinner(text="üì•–ñ–¥–∏—Ç–µ, –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...", show_time=True):
    data, df = get_data()

# –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
tab1, tab2, tab3  = st.tabs(["üì∂–ê–Ω–∞–ª–∏–∑ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö",
                             "üèÇ–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ 10 –¥–Ω–µ–π",
                             "üèÇ–°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ 50 –¥–Ω–µ–π"])
# –í–∫–ª–∞–¥–∫–∞ tab1
with tab1:
    # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
    t11, t12 = st.tabs(
        ["üì∂–ù–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö",
         "üìà–ì—Ä–∞—Ñ–∏–∫"
         ])
    with t11:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö data
        with st.container(width=800):
            st.write('üì∂–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö DataFrame –∏–∑ API Yahoo Finance')
            st.write(data)
    with t12:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        with st.container(width=800, border=True):
            # –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å matplotlib
            st.write('üìà–ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å matplotlib')
            fig, ax = plt.subplots(2, 1, figsize=(10, 6))
            plot_acf(df, lags=130, ax=ax[0])
            plot_pacf(df, lags=130, ax=ax[1])
            plt.tight_layout()
            st.pyplot(fig, width=800)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä—É–≥–æ–≤–æ–π —Å–ø–∏–Ω–Ω–µ—Ä
with st.spinner(text="üì•–ñ–¥–∏—Ç–µ, –∏–¥–µ—Ç —Ä–∞—Å—á–µ—Ç —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 10 –¥–Ω–µ–π ...",
                show_time=True):
    # –û—Å—Ç–∞–≤–ª—è–µ–º –æ–¥–Ω—É –∫–æ–ª–æ–Ω–∫—É
    df = data[['Close']]
    q = 10
    # –†–∞—Å—á–µ—Ç —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 10 –¥–Ω–µ–π
    df['MA'] = df['Close'].rolling(window=q).mean()

# –í–∫–ª–∞–¥–∫–∞ tab2
with tab2:
    # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
    t21, t22 = st.tabs(
        ["üì∂–ù–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö",
         "üìà–ì—Ä–∞—Ñ–∏–∫"
         ])
    with t21:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö df
        with st.container(width=400):
            st.write('üì∂üèÇ–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ç–æ—Ä–≥–æ–≤ - Close –∏ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ - MA –∑–∞ 10 –¥–Ω–µ–π ')
            st.write(df)
    with t22:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        with st.container(width=800, border=True):
            # –§–æ—Ä–º–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ –∞–∫—Ü–∏–π
            fig = go.Figure()
            fig.add_trace(go.Scatter(x=df.index, y=df['Close'], name="–ê–∫—Ü–∏–∏ AMD"))
            fig.add_trace(go.Scatter(x=df.index, y=df['MA'], name="–°—Ä–µ–¥–Ω–µ–µ MA"))
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
            fig.update_layout(xaxis_title="–î–∞—Ç–∞",
                              yaxis_title="–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π, $",
                              title='üìàüíπ–ö–æ—Ç–∏—Ä–æ–≤–∫–∏ –∞–∫—Ü–∏–π –æ—Ç Yahoo Finance (—Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ 10 –¥–Ω–µ–π)')
            st.plotly_chart(fig, theme=None)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä—É–≥–æ–≤–æ–π —Å–ø–∏–Ω–Ω–µ—Ä
with st.spinner(text="üì•–ñ–¥–∏—Ç–µ, –∏–¥–µ—Ç —Ä–∞—Å—á–µ—Ç —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 50 –¥–Ω–µ–π ...",
                show_time=True):
    q = 50
    # –†–∞—Å—á–µ—Ç —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ 50 –¥–Ω–µ–π
    df['MA'] = df['Close'].rolling(window=q).mean()

# –í–∫–ª–∞–¥–∫–∞ tab3
with tab3:
    # –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
    t31, t32 = st.tabs(
        ["üì∂–ù–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö",
         "üìà–ì—Ä–∞—Ñ–∏–∫"
         ])
    with t31:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö df
        with st.container(width=400):
            st.write('üì∂üèÇ–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ç–æ—Ä–≥–æ–≤ - Close –∏ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ - MA –∑–∞ 50 –¥–Ω–µ–π')
            st.write(df)
    with t32:
        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
        with st.container(width=800, border=True):
            # –§–æ—Ä–º–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ –∞–∫—Ü–∏–π
            fig = go.Figure()
            fig.add_trace(go.Scatter(x=df.index, y=df['Close'], name="–ê–∫—Ü–∏–∏ AMD"))
            fig.add_trace(go.Scatter(x=df.index, y=df['MA'], name="–°—Ä–µ–¥–Ω–µ–µ MA"))
            # –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π
            fig.update_layout(xaxis_title="–î–∞—Ç–∞",
                              yaxis_title="–°—Ç–æ–∏–º–æ—Å—Ç—å –∞–∫—Ü–∏–π, $",
                              title='üìàüíπ–ö–æ—Ç–∏—Ä–æ–≤–∫–∏ –∞–∫—Ü–∏–π –æ—Ç Yahoo Finance (—Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ 50 –¥–Ω–µ–π)')
            st.plotly_chart(fig, theme=None)
