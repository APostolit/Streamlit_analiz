import streamlit as st
import plotly.graph_objects as go
import pandas as pd

# –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
@st.cache_data
def get_data(d_start, d_end, val):
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –±–∞–Ω–∫
        url_cb = 'https://www.cbr.ru/scripts/XML_dynamic.asp?'
        date_req1 = 'date_req1='
        date_req2 = '&date_req2='
        VAL_NM_RQ = '&VAL_NM_RQ='
        url = url_cb + date_req1 + d_start + date_req2 + d_end + VAL_NM_RQ + val
        dat = pd.read_xml(url)
        # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ –Ω–∞ —Ç–æ—á–∫–∏ –≤ —Å—Ç–æ–ª–±—Ü–µ —Å –≤–∞–ª—é—Ç–æ–π
        dat['Value'] = dat['Value'].str.replace(',', '.')
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ —Å –≤–∞–ª—é—Ç–æ–π
        dat['Value'] = dat['Value'].astype(float)
        # –í –¥–∞—Ç–µ –∑–∞–º–µ–Ω—è–µ–º —Ç–æ—á–∫–∏ –Ω–∞ "-"
        dat['Date'] = dat['Date'].str.replace('.', '-')
        # –ó–∞–º–µ–Ω—è–µ–º —Å—Ç—Ä–æ–∫–æ–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –¥–∞—Ç–æ–π –Ω–∞ datetime
        dat['Date'] = pd.to_datetime(dat['Date'], format='%d-%m-%Y', errors='coerce')
        return dat
    except Exception as e:
        st.error(f'–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}', icon="üö®")

st.subheader('üì•üßπ–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞üèõÔ∏è')
st.markdown('##### üí±–û–±–º–µ–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç')

# –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
t1, t2, t3, t4 = st.tabs(
    ["üì∂ –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ üí≤",
     "üì∂ –ö—É—Ä—Å –µ–≤—Ä–æ ‚Ç¨",
     "üì∂ –ö—É—Ä—Å —Ñ—É–Ω—Ç–∞ ¬£",
     "üìà –ì—Ä–∞—Ñ–∏–∫",
     ])

# –î–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
d1 = '01/01/2020'
d2 = '21/04/2025'

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä—É–≥–æ–≤–æ–π —Å–ø–∏–Ω–Ω–µ—Ä
with st.spinner(text="üì•–ñ–¥–∏—Ç–µ, –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...", show_time=True):
    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ - –∫—É—Ä—Å$
    kod_val = 'R01235'  # –í–∞–ª—é—Ç–∞ $
    df_d = get_data(d1, d2, kod_val)

    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ - –∫—É—Ä—Å –ï–≤—Ä–æ
    kod_val = 'R01239'  # –ï–≤—Ä–æ
    df_e = get_data(d1, d2, kod_val)

    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ - –∫—É—Ä—Å —Ñ—É–Ω—Ç–∞
    kod_val = 'R01035'  # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —Ñ—É–Ω—Ç
    df_f = get_data(d1, d2, kod_val)

# –í–∫–ª–∞–¥–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
with t1:
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å $
    with st.container(width=600):
        st.write('üí≤ –ö—É—Ä—Å $ –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞')
        st.write(df_d)

# –í–∫–ª–∞–¥–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
with t2:
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å –µ–≤—Ä–æ
    with st.container(width=600):
        st.write('‚Ç¨ –ö—É—Ä—Å –µ–≤—Ä–æ –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞')
        st.write(df_e)

# –í–∫–ª–∞–¥–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
with t3:
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å —Ñ—É–Ω—Ç–∞
    with st.container(width=600):
        st.write('¬£ –ö—É—Ä—Å —Ñ—É–Ω—Ç–∞ –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞')
        st.write(df_f)

# –°–æ–∑–¥–∞—Ç—å –æ–±—ä–µ–∫—Ç - –ì—Ä–∞—Ñ–∏–∫ (—Ñ–∏–≥—É—Ä–∞)
fig = go.Figure()
# –î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ —ç–ª–µ–º–µ–Ω—Ç—ã (–ª–∏–Ω–∏–∏)
fig.add_trace(go.Scatter(x=df_d['Date'], y=df_d['Value'], name='–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ $'))
fig.add_trace(go.Scatter(x=df_e['Date'], y=df_e['Value'], name='–ö—É—Ä—Å –µ–≤—Ä–æ ‚Ç¨'))
fig.add_trace(go.Scatter(x=df_f['Date'], y=df_f['Value'], name='–ö—É—Ä—Å —Ñ—É–Ω—Ç–∞ ¬£'))
tit = 'üìà–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –∏–∑ API –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ —Å ' + d1 + ' –ø–æ ' + d2
fig.update_layout(xaxis_title='–ì–æ–¥—ã', yaxis_title='–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç', title=tit)

# –í–∫–ª–∞–¥–∫–∞ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º
with t4:
    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    with st.container(width=800, border=True):
        st.plotly_chart(fig, theme=None)